## äº¤æ˜“æ•°é‡è®¡ç®—é€»è¾‘è¯´æ˜Ž

### ðŸ“Š è®¡ç®—å…¬å¼

```python
async def _calculate_quantity(
    symbol: str,
    suggested_weight: float,
    account_equity: float,
    current_price: float,
    risk_budget: Optional[float] = None
) -> int:
    """è®¡ç®—äº¤æ˜“æ•°é‡"""
    # 1. ç¡®å®šä½¿ç”¨çš„ä»“ä½é¢„ç®—
    budget = risk_budget if risk_budget else suggested_weight
    
    # 2. è®¡ç®—ç›®æ ‡æŒä»“å¸‚å€¼
    target_value = account_equity * budget
    
    # 3. è®¡ç®—è‚¡ç¥¨æ•°é‡ï¼ˆå‘ä¸‹å–æ•´ï¼‰
    quantity = int(target_value / current_price)
    
    # 4. è‡³å°‘ä¹°1è‚¡
    return max(1, quantity)
```

---

### ðŸ§® æ‚¨çš„æ¡ˆä¾‹è®¡ç®—è¿‡ç¨‹

**è¾“å…¥æ•°æ®**ï¼ˆæ¥è‡ªæˆªå›¾ï¼‰ï¼š
- **å½“å‰ä»·æ ¼**: $668.69
- **å»ºè®®æƒé‡**: 22.0% (suggested_weight = 0.22)
- **è´¦æˆ·å æ¯”**: 22.0%
- **æŒä»“å¸‚å€¼**: $213,312

**æ­¥éª¤1: åæŽ¨è´¦æˆ·æƒç›Š**
```
è´¦æˆ·æƒç›Š = æŒä»“å¸‚å€¼ Ã· è´¦æˆ·å æ¯”
         = $213,312 Ã· 0.22
         = $969,600
```

**æ­¥éª¤2: è®¡ç®—ä»“ä½é¢„ç®—**
```
budget = suggested_weight = 0.22 (22%)
```

**æ­¥éª¤3: è®¡ç®—ç›®æ ‡æŒä»“å¸‚å€¼**
```
target_value = account_equity Ã— budget
             = $969,600 Ã— 0.22
             = $213,312
```

**æ­¥éª¤4: è®¡ç®—è‚¡ç¥¨æ•°é‡**
```
quantity = int(target_value Ã· current_price)
         = int($213,312 Ã· $668.69)
         = int(319.002...)
         = 319 è‚¡
```

**éªŒè¯**ï¼š
```
å®žé™…æŒä»“å¸‚å€¼ = 319 Ã— $668.69 = $213,312.11 âœ…
è´¦æˆ·å æ¯” = $213,312 Ã· $969,600 = 22.0% âœ…
```

---

### ðŸŽ¯ è®¡ç®—é€»è¾‘è¯´æ˜Ž

#### æ ¸å¿ƒæ€è·¯
æ ¹æ®**å»ºè®®æƒé‡**å’Œ**è´¦æˆ·æƒç›Š**ï¼Œè®¡ç®—å‡ºåº”è¯¥æŒæœ‰çš„**ç›®æ ‡å¸‚å€¼**ï¼Œå†é™¤ä»¥**å½“å‰ä»·æ ¼**å¾—åˆ°è‚¡æ•°ã€‚

#### å…³é”®å‚æ•°è¯´æ˜Ž

1. **suggested_weight** (å»ºè®®æƒé‡)
   - æ¥æºï¼šç­–ç•¥è¿è¡Œç»“æžœä¸­çš„ `asset.weight`
   - å«ä¹‰ï¼šè¯¥æ ‡çš„åº”å è´¦æˆ·çš„ç™¾åˆ†æ¯”
   - ç¤ºä¾‹ï¼š0.22 è¡¨ç¤ºå»ºè®®ç”¨ 22% çš„è´¦æˆ·èµ„é‡‘ä¹°å…¥

2. **account_equity** (è´¦æˆ·æƒç›Š)
   - æ¥æºï¼šåˆ¸å•† API èŽ·å–çš„å®žæ—¶è´¦æˆ·æ€»èµ„äº§
   - è®¡ç®—ï¼šä»Žæ‚¨çš„æ¡ˆä¾‹æŽ¨ç®—çº¦ä¸º $969,600

3. **current_price** (å½“å‰ä»·æ ¼)
   - æ¥æºï¼šMarketDataProviderï¼ˆTiger API æˆ– Yahoo Financeï¼‰
   - å®žæ—¶æ€§ï¼šæœ‰ 60 ç§’ç¼“å­˜

4. **risk_budget** (é£Žé™©é¢„ç®—)
   - å¯é€‰å‚æ•°ï¼šç”¨æˆ·å¯ä»¥è¦†ç›–å»ºè®®æƒé‡
   - å¦‚æžœä¸æä¾›ï¼Œåˆ™ä½¿ç”¨ suggested_weight

---

### ðŸ“ˆ ä¸åŒåœºæ™¯çš„è®¡ç®—ç¤ºä¾‹

#### åœºæ™¯1: å°ä»“ä½
```python
account_equity = $100,000
suggested_weight = 0.05 (5%)
current_price = $100

target_value = $100,000 Ã— 0.05 = $5,000
quantity = int($5,000 Ã· $100) = 50è‚¡
```

#### åœºæ™¯2: é«˜ä»·è‚¡
```python
account_equity = $100,000
suggested_weight = 0.10 (10%)
current_price = $3,000 (å¦‚ AMZN)

target_value = $100,000 Ã— 0.10 = $10,000
quantity = int($10,000 Ã· $3,000) = 3è‚¡
```

#### åœºæ™¯3: ç”¨æˆ·è‡ªå®šä¹‰é£Žé™©é¢„ç®—
```python
account_equity = $100,000
suggested_weight = 0.15 (ç­–ç•¥å»ºè®®15%)
risk_budget = 0.10 (ç”¨æˆ·é™ä½Žåˆ°10%)
current_price = $200

# ä½¿ç”¨ risk_budget è¦†ç›– suggested_weight
target_value = $100,000 Ã— 0.10 = $10,000
quantity = int($10,000 Ã· $200) = 50è‚¡
```

---

### âš ï¸ æ³¨æ„äº‹é¡¹

1. **å‘ä¸‹å–æ•´**
   - ä½¿ç”¨ `int()` å‘ä¸‹å–æ•´ï¼Œä¸ä¼šè¶…å‡ºé¢„ç®—
   - å®žé™…æŒä»“å¸‚å€¼å¯èƒ½ç•¥å°äºŽç›®æ ‡å¸‚å€¼

2. **æœ€å°1è‚¡**
   - `return max(1, quantity)` ç¡®ä¿è‡³å°‘ä¹°1è‚¡
   - é¿å…è®¡ç®—ç»“æžœä¸º0

3. **ä¸è€ƒè™‘æ‰‹æ•°é™åˆ¶**
   - å½“å‰é€»è¾‘æœªå¤„ç†æ¸¯è‚¡çš„"æ‰‹æ•°"ï¼ˆlot_sizeï¼‰
   - ç¾Žè‚¡é€šå¸¸å¯ä»¥ä¹°1è‚¡ï¼Œæ¸¯è‚¡éœ€è¦æ•´æ‰‹ï¼ˆå¦‚100è‚¡/æ‰‹ï¼‰

4. **ä»·æ ¼å®žæ—¶æ€§**
   - ä½¿ç”¨å®žæ—¶ä»·æ ¼ï¼Œä½†æœ‰60ç§’ç¼“å­˜
   - å¦‚æžœå¸‚åœºæ³¢åŠ¨å¤§ï¼Œå®žé™…æˆäº¤ä»·æ ¼å¯èƒ½ä¸åŒ

---

### ðŸ”§ ä»£ç ä½ç½®

**æ–‡ä»¶**: `app/services/quick_trade_service.py`  
**æ–¹æ³•**: `_calculate_quantity()`  
**è¡Œæ•°**: 261-275

---

### ðŸ’¡ æ”¹è¿›å»ºè®®

1. **æ”¯æŒæ¸¯è‚¡æ‰‹æ•°**
   ```python
   # èŽ·å–è¯¥æ ‡çš„çš„ lot_size
   lot_size = await self.market_data.get_lot_size(symbol)
   
   # æŒ‰æ‰‹æ•°è°ƒæ•´æ•°é‡
   quantity = int(target_value / current_price / lot_size) * lot_size
   ```

2. **è€ƒè™‘äº¤æ˜“è´¹ç”¨**
   ```python
   # é¢„ç•™äº¤æ˜“è´¹ç”¨ï¼ˆå¦‚0.1%ï¼‰
   adjusted_value = target_value * 0.999
   quantity = int(adjusted_value / current_price)
   ```

3. **æ”¯æŒç¢Žè‚¡äº¤æ˜“**
   ```python
   # ç¾Žè‚¡æ”¯æŒç¢Žè‚¡ï¼Œå¯ä»¥æ›´ç²¾ç¡®
   quantity = round(target_value / current_price, 2)  # ä¿ç•™2ä½å°æ•°
   ```

4. **æœ€å¤§æŒä»“é™åˆ¶**
   ```python
   # ä¸è¶…è¿‡è´¦æˆ·30%
   max_ratio = 0.30
   max_value = account_equity * max_ratio
   if target_value > max_value:
       target_value = max_value
   ```
