## ä»·æ ¼å‡†ç¡®æ€§ä¸å¸‚ä»·å•æ¨¡å¼ - ä¿®æ”¹æ€»ç»“

### ğŸ¯ æ ¸å¿ƒéœ€æ±‚

**ç”¨æˆ·è¦æ±‚**ï¼š
> æ‰€æœ‰ä»·æ ¼ã€æ•°é‡ç›¸å…³å­—æ®µï¼Œå¿…é¡»ä¿è¯å€¼çš„å®æ—¶æ€§ã€å‡†ç¡®æ€§ï¼Œå¦åˆ™è¿”å›å¯¹åº”é”™è¯¯ã€‚å¦‚æœæ— æ³•åšåˆ°ï¼Œè·å–ä¸åˆ°å½“å‰ä»·æ ¼å°±ä»¥å¸‚ä»·æˆäº¤æ–¹å¼ä¸‹å•ï¼Œä¸”ä¸è®¾ç½®å¯¹åº”çš„æ­¢ç›ˆã€æ­¢æŸä»·ä½ã€‚

---

### âœ… å·²å®Œæˆä¿®æ”¹

#### 1. åç«¯ä¿®æ”¹ (3ä¸ªæ–‡ä»¶)

##### 1.1 `backend/app/services/quick_trade_service.py`

**ä¿®æ”¹å†…å®¹**ï¼š

1. **ä»·æ ¼è·å–é€»è¾‘** - ç¡®ä¿å‡†ç¡®æ€§
   ```python
   # ä¿®æ”¹å‰: è¿”å›é»˜è®¤å€¼ 100.0
   async def _get_current_price(self, symbol: str) -> float:
       price = await self.market_data.get_current_price(symbol)
       return price if price and price > 0 else 100.0
   
   # ä¿®æ”¹å: æŠ›å‡ºå¼‚å¸¸
   async def _get_current_price(self, symbol: str) -> float:
       price = await self.market_data.get_current_price(symbol)
       if not price or price <= 0:
           raise ValueError(f"æ— æ³•è·å– {symbol} çš„å‡†ç¡®ä»·æ ¼")
       return price
   ```

2. **è´¦æˆ·æƒç›Šè·å–** - ç¡®ä¿å‡†ç¡®æ€§
   ```python
   # ä¿®æ”¹å‰: è¿”å›é»˜è®¤å€¼ 1000000.0
   async def _get_account_equity(self) -> float:
       equity = await self.broker.get_account_equity(account_id)
       return equity if equity > 0 else 1000000.0
   
   # ä¿®æ”¹å: æŠ›å‡ºå¼‚å¸¸
   async def _get_account_equity(self) -> float:
       equity = await self.broker.get_account_equity(account_id)
       if not equity or equity <= 0:
           raise ValueError(f"è´¦æˆ·æƒç›Šæ•°æ®å¼‚å¸¸: {equity}")
       return equity
   ```

3. **é¢„è§ˆé€»è¾‘æ”¯æŒåŒæ¨¡å¼**
   - **æ¨¡å¼A - é™ä»·å•**ï¼šæœ‰å‡†ç¡®ä»·æ ¼ï¼Œæ­£å¸¸è®¡ç®—æ•°é‡ã€æ­¢ç›ˆæ­¢æŸ
   - **æ¨¡å¼B - å¸‚ä»·å•**ï¼šæ— ä»·æ ¼æ—¶ï¼Œä¸è®¡ç®—æ•°é‡ã€ä¸è®¾ç½®æ­¢ç›ˆæ­¢æŸ
   
   ```python
   async def preview_quick_trade(...) -> Dict[str, Any]:
       # å°è¯•è·å–ä»·æ ¼
       try:
           current_price = await self._get_current_price(symbol)
           # é™ä»·å•æ¨¡å¼
           return {
               "order_mode": "LIMIT",
               "price_available": True,
               "current_price": 670.49,
               "calculated_quantity": 2135,
               "calculated_stop_loss": 637.00,
               "calculated_take_profit": 771.00,
               ...
           }
       except Exception:
           # å¸‚ä»·å•æ¨¡å¼
           return {
               "order_mode": "MARKET",
               "price_available": False,
               "current_price": None,
               "calculated_quantity": None,
               "calculated_stop_loss": None,
               "calculated_take_profit": None,
               "warning": "æ— æ³•è·å–å®æ—¶ä»·æ ¼ï¼Œå°†ä»¥å¸‚ä»·å•æ‰§è¡Œï¼Œä¸è®¾ç½®æ­¢ç›ˆæ­¢æŸ"
           }
   ```

4. **ä¿¡å·åˆ›å»ºæ”¯æŒå¸‚ä»·å•**
   ```python
   async def _create_signal_from_preview(...) -> TradingSignal:
       signal = TradingSignal(
           suggested_quantity=preview.get("calculated_quantity"),  # å¯ä¸º None
           suggested_price=preview.get("current_price"),  # å¯ä¸º None
           stop_loss=preview.get("calculated_stop_loss"),  # å¯ä¸º None
           take_profit=preview.get("calculated_take_profit"),  # å¯ä¸º None
           notes=f"{notes} | Order Mode: {order_mode}"
       )
   ```

##### 1.2 `backend/docs/PRICE_ACCURACY_FIX.md`
- è¯¦ç»†æµ‹è¯•æ–‡æ¡£
- åŒ…å«åœºæ™¯è¯´æ˜ã€éªŒæ”¶æ ‡å‡†ã€éƒ¨ç½²æ­¥éª¤

---

#### 2. å‰ç«¯ä¿®æ”¹ (1ä¸ªæ–‡ä»¶)

##### 2.1 `frontend/src/components/QuickTradeDialog.vue`

**ä¿®æ”¹å†…å®¹**ï¼š

1. **æ¥å£ç±»å‹å®šä¹‰**
   ```typescript
   interface QuickTradePreview {
     order_mode?: string;        // 'LIMIT' | 'MARKET'
     price_available?: boolean;  // ä»·æ ¼æ˜¯å¦å¯ç”¨
     current_price: number | null;
     calculated_quantity: number | null;
     calculated_stop_loss: number | null;
     calculated_take_profit: number | null;
     warning?: string;           // å¸‚ä»·å•è­¦å‘Š
   }
   ```

2. **å¸‚ä»·å•è­¦å‘Šæ¨ªå¹…**
   ```vue
   <div v-if="!preview.price_available" class="warning-banner">
     <span class="warning-icon">âš ï¸</span>
     <div class="warning-content">
       <strong>å¸‚ä»·å•æ¨¡å¼</strong>
       <p>{{ preview.warning }}</p>
     </div>
   </div>
   ```

3. **ä»·æ ¼æ˜¾ç¤ºå¤„ç†**
   ```vue
   <!-- æœ‰ä»·æ ¼æ—¶æ˜¾ç¤ºå…·ä½“ä»·æ ¼ -->
   <span v-if="preview.current_price" class="value price-value">
     ${{ preview.current_price.toFixed(2) }}
   </span>
   <!-- æ— ä»·æ ¼æ—¶æ˜¾ç¤º"å¸‚ä»·" -->
   <span v-else class="value price-value market-price">
     å¸‚ä»·
   </span>
   ```

4. **è¾“å…¥æ¡†ç¦ç”¨å¤„ç†**
   ```vue
   <!-- å¸‚ä»·å•æ¨¡å¼ï¼šç¦ç”¨æ•°é‡è¾“å…¥ -->
   <input v-if="preview.calculated_quantity" type="number" ... />
   <input v-else type="text" value="å¸‚ä»·æˆäº¤" disabled class="input-field disabled" />
   
   <!-- å¸‚ä»·å•æ¨¡å¼ï¼šç¦ç”¨æ­¢æŸè¾“å…¥ -->
   <input v-if="preview.calculated_stop_loss !== null" type="number" ... />
   <input v-else type="text" value="ä¸è®¾ç½®" disabled class="input-field disabled" />
   ```

5. **è­¦å‘Šæ¨ªå¹…æ ·å¼**
   ```css
   .warning-banner {
     background: linear-gradient(135deg, rgba(255, 152, 0, 0.15) 0%, rgba(255, 193, 7, 0.08) 100%);
     border: 1px solid rgba(255, 152, 0, 0.4);
     animation: pulse-warning 2s ease-in-out infinite;
   }
   ```

---

### ğŸ“Š æ•°æ®æµå¯¹æ¯”

#### ä¹‹å‰çš„æµç¨‹ï¼ˆå­˜åœ¨é—®é¢˜ï¼‰
```
ç”¨æˆ·ç‚¹å‡»å¿«æ·äº¤æ˜“
  â†“
è°ƒç”¨ preview API
  â†“
åç«¯å°è¯•è·å–ä»·æ ¼
  â”œâ”€ æˆåŠŸ: è¿”å›çœŸå®ä»·æ ¼
  â””â”€ å¤±è´¥: è¿”å›é»˜è®¤å€¼ 100.0 âŒ
  â†“
å‰ç«¯æ˜¾ç¤ºä»·æ ¼ (å¯èƒ½æ˜¯é”™è¯¯çš„ $100.00)
  â†“
ç”¨æˆ·ç¡®è®¤äº¤æ˜“ (åŸºäºé”™è¯¯ä»·æ ¼) âŒ
```

#### ä¿®æ”¹åçš„æµç¨‹ï¼ˆæ­£ç¡®ï¼‰
```
ç”¨æˆ·ç‚¹å‡»å¿«æ·äº¤æ˜“
  â†“
è°ƒç”¨ preview API
  â†“
åç«¯å°è¯•è·å–ä»·æ ¼
  â”œâ”€ æˆåŠŸ: é™ä»·å•æ¨¡å¼
  â”‚   âœ… è¿”å›çœŸå®ä»·æ ¼ $670.49
  â”‚   âœ… è®¡ç®—ç²¾ç¡®æ•°é‡ 2135è‚¡
  â”‚   âœ… è®¾ç½®æ­¢ç›ˆæ­¢æŸ
  â”‚
  â””â”€ å¤±è´¥: å¸‚ä»·å•æ¨¡å¼
      âœ… è¿”å› price_available: false
      âœ… è¿”å›è­¦å‘Šä¿¡æ¯
      âœ… ä¸è®¡ç®—æ•°é‡ã€ä¸è®¾ç½®æ­¢ç›ˆæ­¢æŸ
  â†“
å‰ç«¯æ ¹æ® order_mode æ˜¾ç¤º
  â”œâ”€ LIMIT: æ˜¾ç¤ºä»·æ ¼ã€æ•°é‡ã€æ­¢ç›ˆæ­¢æŸ
  â””â”€ MARKET: æ˜¾ç¤ºè­¦å‘Šæ¨ªå¹…ã€ç¦ç”¨éƒ¨åˆ†è¾“å…¥
  â†“
ç”¨æˆ·æ˜ç¡®çŸ¥é“å½“å‰æ¨¡å¼
  â”œâ”€ é™ä»·å•: åŸºäºå‡†ç¡®æ•°æ®ç¡®è®¤
  â””â”€ å¸‚ä»·å•: çŸ¥é“å°†ä»¥å¸‚ä»·æˆäº¤ âœ…
```

---

### ğŸ§ª æµ‹è¯•éªŒè¯

#### æµ‹è¯•åœºæ™¯1: ä»·æ ¼è·å–æˆåŠŸï¼ˆé™ä»·å•ï¼‰
```bash
curl http://localhost:8000/api/v1/strategy-runs/{run_id}/assets/META/preview
```

**é¢„æœŸå“åº”**:
```json
{
  "order_mode": "LIMIT",
  "price_available": true,
  "current_price": 670.49,
  "calculated_quantity": 2135,
  "calculated_stop_loss": 637.00,
  "calculated_take_profit": 771.00
}
```

**å‰ç«¯æ˜¾ç¤º**:
- å½“å‰ä»·æ ¼: $670.49 âœ…
- äº¤æ˜“æ•°é‡: 2135 è‚¡ âœ…
- æ­¢æŸä»·: $637.00 âœ…
- æ­¢ç›ˆä»·: $771.00 âœ…
- æ— è­¦å‘Šæ¨ªå¹… âœ…

---

#### æµ‹è¯•åœºæ™¯2: ä»·æ ¼è·å–å¤±è´¥ï¼ˆå¸‚ä»·å•ï¼‰
```bash
# æ¨¡æ‹Ÿ: Tiger API æœªé…ç½® && Yahoo Finance å¤±è´¥
```

**é¢„æœŸå“åº”**:
```json
{
  "order_mode": "MARKET",
  "price_available": false,
  "current_price": null,
  "calculated_quantity": null,
  "calculated_stop_loss": null,
  "calculated_take_profit": null,
  "warning": "æ— æ³•è·å–å®æ—¶ä»·æ ¼ï¼Œå°†ä»¥å¸‚ä»·å•æ‰§è¡Œï¼Œä¸è®¾ç½®æ­¢ç›ˆæ­¢æŸ"
}
```

**å‰ç«¯æ˜¾ç¤º**:
- âš ï¸ è­¦å‘Šæ¨ªå¹…ï¼ˆæ©™è‰²è„‰å†²åŠ¨ç”»ï¼‰ âœ…
- å½“å‰ä»·æ ¼: å¸‚ä»· âœ…
- äº¤æ˜“æ•°é‡: å¸‚ä»·æˆäº¤ï¼ˆç¦ç”¨è¾“å…¥æ¡†ï¼‰ âœ…
- æ­¢æŸä»·: ä¸è®¾ç½®ï¼ˆç¦ç”¨è¾“å…¥æ¡†ï¼‰ âœ…
- æ­¢ç›ˆä»·: ä¸è®¾ç½®ï¼ˆç¦ç”¨è¾“å…¥æ¡†ï¼‰ âœ…

---

### ğŸ¨ UI æ•ˆæœé¢„è§ˆ

#### é™ä»·å•æ¨¡å¼
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš¡ å¿«æ·äº¤æ˜“                          â”‚
â”‚ META                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¸‚åœºä¿¡æ¯                            â”‚
â”‚ å½“å‰ä»·æ ¼        ä¿¡å·å¼ºåº¦             â”‚
â”‚ $670.49         â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 90.6     â”‚
â”‚                                     â”‚
â”‚ äº¤æ˜“å‚æ•°                            â”‚
â”‚ äº¤æ˜“æ•°é‡: [2135        ] è‚¡         â”‚
â”‚ æ­¢æŸä»·:   [637.00      ]           â”‚
â”‚ æ­¢ç›ˆä»·:   [771.00      ]           â”‚
â”‚                                     â”‚
â”‚ [å–æ¶ˆ] [åˆ›å»ºè®¡åˆ’] [é™ä»·å•] [å¸‚ä»·å•] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å¸‚ä»·å•æ¨¡å¼
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš¡ å¿«æ·äº¤æ˜“                          â”‚
â”‚ META                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âš ï¸  å¸‚ä»·å•æ¨¡å¼                      â”‚
â”‚     æ— æ³•è·å–å®æ—¶ä»·æ ¼ï¼Œå°†ä»¥å¸‚ä»·å•æ‰§è¡Œ â”‚
â”‚     ä¸è®¾ç½®æ­¢ç›ˆæ­¢æŸ                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¸‚åœºä¿¡æ¯                            â”‚
â”‚ å½“å‰ä»·æ ¼        ä¿¡å·å¼ºåº¦             â”‚
â”‚ å¸‚ä»·            â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 90.6     â”‚
â”‚                                     â”‚
â”‚ äº¤æ˜“å‚æ•°                            â”‚
â”‚ äº¤æ˜“æ•°é‡: [å¸‚ä»·æˆäº¤    ] è‚¡ (ç¦ç”¨)  â”‚
â”‚ æ­¢æŸä»·:   [ä¸è®¾ç½®      ] (ç¦ç”¨)     â”‚
â”‚ æ­¢ç›ˆä»·:   [ä¸è®¾ç½®      ] (ç¦ç”¨)     â”‚
â”‚                                     â”‚
â”‚ [å–æ¶ˆ] [åˆ›å»ºè®¡åˆ’] [é™ä»·å•] [å¸‚ä»·å•] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### ğŸ“‹ éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] åç«¯ä»£ç å·²ä¿®æ”¹: `quick_trade_service.py`
- [ ] å‰ç«¯ä»£ç å·²ä¿®æ”¹: `QuickTradeDialog.vue`
- [ ] æ•°æ®åº“å­—æ®µå…è®¸ NULL: `suggested_price`, `suggested_quantity`, `stop_loss`, `take_profit`
- [ ] æµ‹è¯•é™ä»·å•æ¨¡å¼ï¼šä»·æ ¼è·å–æˆåŠŸåœºæ™¯
- [ ] æµ‹è¯•å¸‚ä»·å•æ¨¡å¼ï¼šä»·æ ¼è·å–å¤±è´¥åœºæ™¯
- [ ] æµ‹è¯•æ‰¹é‡äº¤æ˜“ï¼šéƒ¨åˆ†ä»·æ ¼å¤±è´¥åœºæ™¯
- [ ] æ£€æŸ¥æ—¥å¿—è¾“å‡ºï¼šä»·æ ¼è·å–æ¥æºæ ‡è®°
- [ ] æ£€æŸ¥ä¿¡å·è®°å½•ï¼šOrder Mode æ ‡è®°
- [ ] å‰ç«¯ UI éªŒè¯ï¼šè­¦å‘Šæ¨ªå¹…æ˜¾ç¤º
- [ ] å‰ç«¯ UI éªŒè¯ï¼šç¦ç”¨è¾“å…¥æ¡†æ ·å¼

---

### ğŸš€ æŠ•äº§ä¿¡æ¯

**ä¿®æ”¹æ—¶é—´**: 2026-02-12  
**ç‰ˆæœ¬å·**: v3.0.2+price-accuracy-fix  
**ä¿®æ”¹äºº**: AI Assistant  
**æµ‹è¯•çŠ¶æ€**: å¾…æµ‹è¯•  
**å½±å“èŒƒå›´**: 
- å¿«æ·äº¤æ˜“åŠŸèƒ½ï¼ˆå•èµ„äº§ã€æ‰¹é‡ï¼‰
- äº¤æ˜“é¢„è§ˆæ¥å£
- äº¤æ˜“ä¿¡å·åˆ›å»º
- å‰ç«¯äº¤æ˜“å¯¹è¯æ¡†UI

**å›æ»šæ–¹æ¡ˆ**:
```bash
git revert HEAD
# æˆ–æ¢å¤åˆ° v3.0.2 ç‰ˆæœ¬
git checkout v3.0.2
```

---

### ğŸ’¡ åç»­å»ºè®®

1. **ç›‘æ§æŠ¥è­¦**: ç›‘æ§å¸‚ä»·å•ä½¿ç”¨é¢‘ç‡ï¼Œå¦‚æœè¿‡é«˜è¯´æ˜ä»·æ ¼æœåŠ¡æœ‰é—®é¢˜
2. **ç”¨æˆ·æç¤ºä¼˜åŒ–**: å¸‚ä»·å•é£é™©æç¤ºæ›´æ˜ç¡®
3. **å†å²ä»·æ ¼å›é€€**: è€ƒè™‘ä½¿ç”¨æœ€è¿‘çš„å†å²ä»·æ ¼ï¼ˆå¸¦æ—¶é—´æˆ³ï¼‰ä½œä¸ºå‚è€ƒ
4. **ä»·æ ¼æ•°æ®æºé…ç½®**: æ”¯æŒå¤šæ•°æ®æºä¼˜å…ˆçº§é…ç½®
